name: Deploy to Maven Central

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to publish (e.g., 1.0.0)'
        required: true
        type: string
      stage_only:
        description: 'Only stage to OSSRH (no auto-release)'
        required: false
        type: boolean
        default: false

jobs:
  test:
    name: Test Java SDK
    runs-on: ubuntu-latest
    strategy:
      matrix:
        java-version: ['11', '17', '21']
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up JDK ${{ matrix.java-version }}
      uses: actions/setup-java@v4
      with:
        java-version: ${{ matrix.java-version }}
        distribution: 'temurin'
        cache: maven
    
    - name: Run tests
      working-directory: ./sdks/java
      run: mvn clean test
    
    - name: Run integration tests
      working-directory: ./sdks/java
      run: mvn verify

  deploy:
    name: Deploy to Maven Central
    needs: test
    runs-on: ubuntu-latest
    environment:
      name: maven-central
      url: https://central.sonatype.com/artifact/dev.huefy/huefy-java-sdk
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: maven
        server-id: ossrh
        server-username: MAVEN_USERNAME
        server-password: MAVEN_PASSWORD
        gpg-private-key: ${{ secrets.MAVEN_GPG_PRIVATE_KEY }}
        gpg-passphrase: MAVEN_GPG_PASSPHRASE
    
    - name: Set version from input (workflow_dispatch)
      if: github.event_name == 'workflow_dispatch'
      working-directory: ./sdks/java
      run: mvn versions:set -DnewVersion=${{ github.event.inputs.version }}
    
    - name: Set version from tag (release)
      if: github.event_name == 'release'
      working-directory: ./sdks/java
      run: |
        VERSION=${GITHUB_REF#refs/tags/v}
        mvn versions:set -DnewVersion=$VERSION
    
    - name: Build and verify
      working-directory: ./sdks/java
      run: mvn clean verify
    
    - name: Configure settings.xml
      run: |
        mkdir -p ~/.m2
        cat > ~/.m2/settings.xml << EOF
        <settings>
          <servers>
            <server>
              <id>ossrh</id>
              <username>${MAVEN_USERNAME}</username>
              <password>${MAVEN_PASSWORD}</password>
            </server>
          </servers>
          <profiles>
            <profile>
              <id>ossrh</id>
              <activation>
                <activeByDefault>true</activeByDefault>
              </activation>
              <properties>
                <gpg.executable>gpg</gpg.executable>
                <gpg.passphrase>${MAVEN_GPG_PASSPHRASE}</gpg.passphrase>
              </properties>
            </profile>
          </profiles>
        </settings>
        EOF
      env:
        MAVEN_USERNAME: ${{ secrets.MAVEN_USERNAME }}
        MAVEN_PASSWORD: ${{ secrets.MAVEN_PASSWORD }}
        MAVEN_GPG_PASSPHRASE: ${{ secrets.MAVEN_GPG_PASSPHRASE }}
    
    - name: Deploy to OSSRH (staging)
      working-directory: ./sdks/java
      run: mvn clean deploy -P release
      env:
        MAVEN_USERNAME: ${{ secrets.MAVEN_USERNAME }}
        MAVEN_PASSWORD: ${{ secrets.MAVEN_PASSWORD }}
        MAVEN_GPG_PASSPHRASE: ${{ secrets.MAVEN_GPG_PASSPHRASE }}
    
    - name: Release to Maven Central
      if: github.event_name == 'release' || (github.event_name == 'workflow_dispatch' && github.event.inputs.stage_only == 'false')
      working-directory: ./sdks/java
      run: |
        # Auto-release from staging to Maven Central
        mvn nexus-staging:release
      env:
        MAVEN_USERNAME: ${{ secrets.MAVEN_USERNAME }}
        MAVEN_PASSWORD: ${{ secrets.MAVEN_PASSWORD }}

  verify-deployment:
    name: Verify Deployment
    needs: deploy
    if: github.event_name == 'release' || (github.event_name == 'workflow_dispatch' && github.event.inputs.stage_only == 'false')
    runs-on: ubuntu-latest
    
    steps:
    - name: Wait for Maven Central sync
      run: sleep 600  # Wait 10 minutes for sync
    
    - name: Verify artifact availability
      run: |
        VERSION=${{ github.event.inputs.version || github.ref_name }}
        VERSION=${VERSION#v}
        
        # Check if artifact is available
        curl -f -s "https://repo1.maven.org/maven2/dev/huefy/huefy-java-sdk/$VERSION/huefy-java-sdk-$VERSION.pom" > /dev/null
        
        if [ $? -eq 0 ]; then
          echo "✅ Artifact successfully deployed to Maven Central"
        else
          echo "⚠️ Artifact not yet available on Maven Central (may take up to 2 hours)"
        fi

  create-release-pr:
    name: Create Release PR
    needs: deploy
    if: github.event_name == 'release'
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: maven
    
    - name: Update to next SNAPSHOT version
      working-directory: ./sdks/java
      run: |
        VERSION=${GITHUB_REF#refs/tags/v}
        # Parse version and increment
        IFS='.' read -ra VERSION_PARTS <<< "$VERSION"
        PATCH=$((VERSION_PARTS[2] + 1))
        NEXT_VERSION="${VERSION_PARTS[0]}.${VERSION_PARTS[1]}.$PATCH-SNAPSHOT"
        mvn versions:set -DnewVersion=$NEXT_VERSION
    
    - name: Create Pull Request
      uses: peter-evans/create-pull-request@v5
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        commit-message: 'chore(java): bump version to next SNAPSHOT'
        title: 'chore(java): bump version after ${{ github.event.release.tag_name }} release'
        body: |
          This PR updates the Java SDK version after the Maven Central release.
          
          Released version: ${{ github.event.release.tag_name }}
          
          The version has been bumped to the next SNAPSHOT version for development.
        branch: release/java-bump-${{ github.event.release.tag_name }}
        delete-branch: true